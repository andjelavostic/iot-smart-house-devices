<!DOCTYPE html>
<html>
<head>
    <title>Smart House Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        h1 { margin-bottom: 10px; }
        .pi-panel { margin-bottom: 40px; }
        .pi-title { font-size: 24px; margin-bottom: 15px; color: #4CAF50; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: #333; padding: 15px; border-radius: 8px; border-left: 5px solid #4CAF50; }
        .camera-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #4CAF50;   /* druga boja da se razlikuje */
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        .camera-card h3 {
            margin-bottom: 10px;
            color: #fff;
        }

        .camera-wrapper {
            width: 100%;
            aspect-ratio: 16 / 9;   /* zadržava proporciju */
            overflow: hidden;
            border-radius: 6px;
            background: #000;
        }

        .camera-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;  /* popunjava prostor bez deformacije */
        }
        .alarm-on { border-left-color: #f44336; animation: blink 1s infinite; }
        .led-on { border-left-color: #2196F3; }
        .buzzer-on { border-left-color: #FF9800; }
        .pir-on { border-left-color: #9C27B0; }
        @keyframes blink { 50% { opacity: 0.5; } }

        button { background: #4CAF50; color: white; border: none; padding: 10px; cursor: pointer; margin-top: 10px; }
        input { padding: 10px; width: 80px; }
        p { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Smart House Monitoring</h1>

    <button onclick="window.location.href='/charts'" style="margin-bottom: 20px;">Prikaži grafike</button>

    <div class="pi-panel" id="pi1-panel">
        <div class="pi-title">PI1 Status</div>
        <div class="grid">
            <div class="camera-card">
                <h3>Kamera</h3>
                <div class="camera-wrapper">
                    <img src="http://192.168.107.150:8080/?action=stream" alt="Kamera">
                </div>
            </div>
            <div class="card" id="card-ALARM">
                <h3>Sistem Alarm</h3>
                <p id="alarm-status">Status: ---</p>
            </div>
            <div class="card">
                <h3>Ljudi u kući</h3>
                <h2 id="people-count">0</h2>
            </div>
            <div class="card" id="card-DS1">
                <h3>Senzor Vrata (DS1)</h3>
                <p id="ds1-val">Vrijednost: 0</p>
            </div>
            <div class="card" id="card-DUS1">
                <h3>Rastojanje (DUS1)</h3>
                <p id="dus1-val">0 cm</p>
            </div>
            <div class="card" id="card-DL">
                <h3>LED Svjetlo (DL)</h3>
                <p id="dl-val">Isključeno</p>
            </div>
            <div class="card" id="card-DB">
                <h3>Buzzer (DB)</h3>
                <p id="db-val">Isključen</p>
            </div>
            <div class="card" id="card-DPIR1">
                <h3>PIR (DPIR1)</h3>
                <p id="dpir1-val">Mirno</p>
            </div>
            <div class="card" id="card-DMS">
                <h3>Membrane (DMS)</h3>
                <p id="dms-val">---</p>
            </div>
        </div>
    </div>

    <!--PI2-->
    <div class="pi-panel" id="pi2-panel">
        <div class="pi-title">PI2 Status (Garage + Kitchen)</div>
        <div class="grid">

            <div class="card">
                <h3>Ljudi (PI2)</h3>
                <h2 id="people-count-pi2">0</h2>
            </div>

            <div class="card" id="card-DS2">
                <h3>Door Sensor (DS2)</h3>
                <p id="ds2-val">Vrijednost: 0</p>
            </div>

            <div class="card" id="card-DUS2">
                <h3>Distance (DUS2)</h3>
                <p id="dus2-val">0 cm</p>
            </div>

            <div class="card" id="card-DPIR2">
                <h3>PIR (DPIR2)</h3>
                <p id="dpir2-val">Mirno</p>
            </div>
            <div class="card">
                <h3>Postavi vreme štoperice</h3>

                <label>Unesi sekunde:</label>
                <input type="number" id="timer-seconds" value="60" min="1">

                <button onclick="setTimer()">Pokreni štopericu</button>
            </div>
            <div class="card" id="card-4SD">
                <h3>Kuhinjska Štoperica (4SD)</h3>
                <p id="display-val">00:00</p>
            </div>

            <div class="card">
                <h3>Štoperica - dodavanje sekundi</h3>
                <label for="add-seconds">Dodaj sekundi:</label>
                <select id="add-seconds" onchange="updateAddSeconds()">
                    <option value="0">0</option>
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="15">15</option>
                    <option value="30">30</option>
                    <option value="60">60</option>
                </select>
                <button onclick="setTimerSeconds()">Dodaj sekundi</button>
            </div>

            <div class="card" id="card-BTN">
                <h3>Kitchen Button</h3>
                <p id="btn-val">---</p>
            </div>

            <div class="card" id="card-DHT3">
                <h3>DHT3 (Kitchen)</h3>
                <p id="dht3-val">---</p>
            </div>

            <div class="card" id="card-GSG">
                <h3>Gyroscope (GSG)</h3>
                <p id="gsg-val">---</p>
            </div>

        </div>
    </div>
    <div class="pi-panel" id="pi3-panel">
        <div class="pi-title">PI3 Status (Bedroom & Living Room)</div>
        <div class="grid">
            <div class="card" id="card-DPIR3">
                <h3>PIR (DPIR3)</h3>
                <p id="dpir3-val">Mirno</p>
            </div>
            <div class="card" id="card-BRGB">
                <h3>Bedroom RGB LED</h3>
                <p id="rgb-val">Status: Off</p>
                <div id="rgb-color-box" style="width: 50px; height: 20px; border: 1px solid white; margin-top: 5px;"></div>
            </div>
            <div class="card" id="card-IR">
                <h3>IR Remote (Living Room)</h3>
                <p id="ir-val">Poslednja komanda: ---</p>
            </div>
            <div class="card">
                <h3>Kontrola RGB (PI3)</h3>
                <button onclick="sendCommand('PI3', 'BRGB', 1, [1,0,0])">Crvena</button>
                <button onclick="sendCommand('PI3', 'BRGB', 1, [0,0,1])">Plava</button>
                <button onclick="sendCommand('PI3', 'BRGB', 1, [0,1,0])">Zelena</button>
                <button onclick="sendCommand('PI3', 'BRGB', 1, [1,0,1])">Ljubicasta</button>
                <button onclick="sendCommand('PI3', 'BRGB', 0)">Ugasi</button>
            </div>
            <div class="card" id="card-LCD">
                <h3>LCD Display</h3>
                <p id="lcd-val" style="background: #002200; color: #00FF00; padding: 5px; font-family: monospace; border: 2px solid #333;">---</p>
            </div>
            <div class="card" id="card-DHT1">
                <h3>DHT1 (Bedroom)</h3>
                <p id="dht1-val">---</p>
            </div>
            <div class="card" id="card-DHT2">
                <h3>DHT2 (Master Bed)</h3>
                <p id="dht2-val">---</p>
            </div>
        </div>
    </div>
    <script>
        const socket = io();

        function updateAlarmStatus(isActive) {
            const el = document.getElementById('card-ALARM');
            const status = document.getElementById('alarm-status');
            if (isActive) {
                el.classList.add('alarm-on');
                status.innerText = "ALARM AKTIVAN!";
            } else {
                el.classList.remove('alarm-on');
                status.innerText = "Sistem OK";
            }
        }
        function sendCommand(pi, device, value, color=null){
            const payload = {pi: pi, device:device, value: value};
            if(color) payload.color = color;
            socket.emit("command", payload);
        }
        function setTimerSeconds() {
            const n = parseInt(document.getElementById('add-seconds').value);

            socket.emit("command", {
                pi: "PI2",
                device: "BTN_CONFIG", 
                value: n
            });
        }
        function setTimer() {
            const seconds = document.getElementById("timer-seconds").value;
                socket.emit("command",
                    {
                        pi :"PI2",
                        device: "TIMERSET",
                        value: seconds
                    }
                );
        }
        socket.on('device_update', function(data) {

            // ================= PI1 =================
            if (data.pi === "PI1") {

                if(data.device === "DS1")
                    document.getElementById('ds1-val').innerText =
                        "Vrednost: " + data.value;

                if(data.device === "DUS1")
                    document.getElementById('dus1-val').innerText =
                        data.value + " cm";

                if(data.measurement === "people")
                    document.getElementById('people-count').innerText =
                        data.value;

                if(data.device === "DL") {
                    const el = document.getElementById('card-DL');
                    document.getElementById('dl-val').innerText =
                        data.value ? "Uključeno" : "Isključeno";
                    el.classList.toggle('led-on', data.value);
                }

                if(data.device === "DB") {
                    const el = document.getElementById('card-DB');
                    document.getElementById('db-val').innerText =
                        data.value ? "Uključen" : "Isključen";
                    el.classList.toggle('buzzer-on', data.value);

                    updateAlarmStatus(data.value);
                }

                if(data.device === "DPIR1") {
                    const el = document.getElementById('card-DPIR1');
                    if(data.value) {
                        el.classList.add('pir-on');
                        document.getElementById('dpir1-val').innerText =
                            "Pokret detektovan!";
                        setTimeout(()=>{
                            el.classList.remove('pir-on');
                            document.getElementById('dpir1-val').innerText =
                                "Mirno";
                        },2000);
                    }
                }

                if(data.device === "DMS")
                    document.getElementById('dms-val').innerText =
                        (typeof data.value === 'object')
                            ? JSON.stringify(data.value)
                            : data.value;
            }

            // ================= PI2 =================
            if (data.pi === "PI2") {

                if(data.device === "DS2")
                    document.getElementById('ds2-val').innerText =
                        "Vrijednost: " + data.value;

                if(data.device === "DUS2")
                    document.getElementById('dus2-val').innerText =
                        data.value + " cm";

                if(data.device === "DPIR2") {
                    const el = document.getElementById('card-DPIR2');
                    if(data.value) {
                        el.classList.add('pir-on');
                        document.getElementById('dpir2-val').innerText =
                            "Pokret!";
                        setTimeout(()=>{
                            el.classList.remove('pir-on');
                            document.getElementById('dpir2-val').innerText =
                                "Mirno";
                        },2000);
                    }
                }

                if(data.measurement === "people")
                    document.getElementById('people-count-pi2').innerText =
                        data.value;

                if(data.device === "4SD")
                    document.getElementById('display-val').innerText =
                        data.value;

                if(data.device === "BTN")
                    document.getElementById('btn-val').innerText =
                        data.value ? "Pritisnuto" : "Idle";

                if(data.device === "DHT3")
                    document.getElementById('dht3-val').innerText =
                        JSON.stringify(data.value);

                if (data.device === "GSG") {
                    const gsgValElement = document.getElementById('gsg-val');
                    
                    if (data.value && data.value.accel && data.value.gyro) {
                        const a = data.value.accel;
                        const g = data.value.gyro;

                        gsgValElement.innerHTML = `
                            <div style="margin-bottom: 5px;">
                                <strong style="color: #4CAF50;">Akselerometar (m/s²):</strong><br>
                                X: ${a[0].toFixed(2)} | Y: ${a[1].toFixed(2)} | Z: ${a[2].toFixed(2)}
                            </div>
                            <div>
                                <strong style="color: #2196F3;">Žiroskop (°/s):</strong><br>
                                X: ${g[0].toFixed(2)} | Y: ${g[1].toFixed(2)} | Z: ${g[2].toFixed(2)}
                            </div>
                        `;
                    } else {
                        gsgValElement.innerText = "Podaci nedostupni";
                    }
                }
            }
            // ================= PI3 =================
            if (data.pi === "PI3") {

                // DHT1 i DHT2
                if (data.device === "DHT1" || data.device === "DHT2") {
                    const el = document.getElementById(data.device.toLowerCase() + '-val');

                    // Preuzimamo prethodno prikazane vrednosti
                    let currentText = el.innerText || "";
                    let temp = currentText.match(/T: ([0-9.\-]+)/);
                    let hum = currentText.match(/H: ([0-9.\-]+)/);

                    // Ako nema, postavimo default
                    temp = temp ? temp[1] : "--";
                    hum = hum ? hum[1] : "--";

                    // Ažuriramo na osnovu field
                    if (data.field === "temperature") temp = data.value;
                    if (data.field === "humidity") hum = data.value;

                    el.innerText = `T: ${temp}°C | H: ${hum}%`;
                }

                // RGB LED
                if(data.device === "BRGB") {
                    const statusText = document.getElementById('rgb-val');
                    const colorBox = document.getElementById('rgb-color-box');
                    // Pretvaramo [1,0,0] u rgb(255, 0, 0)
                    const r = data.value[0] ? 255 : 0;
                    const g = data.value[1] ? 255 : 0;
                    const b = data.value[2] ? 255 : 0;
                    
                    const isAnyOn = (r + g + b) > 0;
                    statusText.innerText = isAnyOn ? "Uključeno" : "Isključeno";
                    colorBox.style.backgroundColor = `rgb(${r},${g},${b})`;
                    document.getElementById('card-BRGB').classList.toggle('led-on', isAnyOn);
                }
                if(data.measurement === "people")
                    document.getElementById('people-count-pi3').innerText =
                        data.value;

                // LCD Display
                if(data.device === "LCD")
                    document.getElementById('lcd-val').innerText = data.value;

                // IR Senzor
                if(data.device === "IR")
                    document.getElementById('ir-val').innerText = "Komanda: " + data.value;

                // PIR3 (Kao i ostali PIR-ovi, blica ljubičasto)
                if(data.device === "DPIR3") {
                    const el = document.getElementById('card-DPIR3');
                    if(data.value) {
                        el.classList.add('pir-on');
                        document.getElementById('dpir3-val').innerText = "Pokret u dnevnoj!";
                        setTimeout(() => {
                            el.classList.remove('pir-on');
                            document.getElementById('dpir3-val').innerText = "Mirno";
                        }, 2000);
                    }
                }
            }
        });

    </script>
</body>
</html>
